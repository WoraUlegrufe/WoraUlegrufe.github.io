<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>QR Начисление</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#000; font-family:sans-serif; overflow:hidden; }

    /* Экран камеры */
    #camera-screen {
      width:100vw; height:100vh;
      display:flex; justify-content:center; align-items:center;
      position:relative;
    }
    #video { width:100%; height:100%; object-fit:cover; }

    /* Прозрачная рамка сканирования */
    .scan-frame {
      position:absolute;
      width:360px; height:360px;
      border:4px solid rgba(0,255,128,0.8);
      border-radius:12px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow:0 0 10px rgba(0,255,128,0.7); }
      50% { box-shadow:0 0 20px rgba(0,255,128,1); }
      100% { box-shadow:0 0 10px rgba(0,255,128,0.7); }
    }

    /* Форма начисления */
    #form-screen {
      display:none; width:100vw; height:100vh;
      background:#1a1a1a; color:#fff;
      padding:30px; text-align:center;
      justify-content:center; align-items:center;
      flex-direction:column;
    }
    #form-screen.show { display:flex; }

    .card {
      background:#fff; color:#000; width:90%; max-width:420px;
      border-radius:20px; padding:30px;
      box-shadow:0 12px 30px rgba(0,0,0,0.4);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn { from{opacity:0; transform:translateY(15px);} to{opacity:1; transform:translateY(0);} }

    h2 { margin-bottom:20px; color:#00c853; }
    .qr-value {
      background:#f0f0f0; padding:14px; border-radius:12px;
      margin:16px 0; font-family:monospace;
      font-size:16px; word-break:break-all;
    }

    input {
      width:100%; padding:14px; font-size:18px;
      margin:16px 0; border:2px solid #ddd;
      border-radius:12px; text-align:center;
    }

    .btn {
      background:#00c853; color:white;
      padding:14px 28px; border:none;
      border-radius:12px; font-size:18px;
      cursor:pointer; margin:8px; transition:0.2s;
    }
    .btn:active { transform:scale(0.95); }
    .btn-secondary { background:#666; }
    .btn:disabled { background:#aaa; cursor:not-allowed; }

    .warning {
      color: #ff5555;
      margin: 8px 0 0;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <!-- ЭКРАН КАМЕРЫ -->
  <div id="camera-screen">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div class="scan-frame"></div>
  </div>

  <!-- ОКНО НАЧИСЛЕНИЯ -->
  <div id="form-screen">
    <div class="card">
      <h2 id="formTitle">Результат сканирования</h2>

      <div class="qr-value" id="qrValue"></div>
      <p class="warning" id="warningText"></p>

      <div id="amountBlock" style="display:none;">
        <input type="number" id="amount" placeholder="Сумма" min="1" />
        <button class="btn" id="accrueBtn" onclick="accrue()">Начислить</button>
      </div>

      <button class="btn btn-secondary" onclick="restart()">Сканировать снова</button>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const cameraScreen = document.getElementById('camera-screen');
    const formScreen = document.getElementById('form-screen');
    const qrValue = document.getElementById('qrValue');
    const warningText = document.getElementById('warningText');
    const amountBlock = document.getElementById('amountBlock');
    const amountInput = document.getElementById('amount');
    const accrueBtn = document.getElementById('accrueBtn');
    let stream = null;
    let lastQr = '';

    // === ЗАПУСК КАМЕРЫ ===
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          requestAnimationFrame(scan);
        };
      } catch (e) {
        alert('Ошибка камеры: ' + e.message);
      }
    }

    // === СКАНИРОВАНИЕ ===
    function scan() {
      if (video.readyState !== video.HAVE_ENOUGH_DATA) {
        requestAnimationFrame(scan);
        return;
      }

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);

      if (code && code.data !== lastQr) {
        lastQr = code.data.trim();
        stopCameraAndShowForm(lastQr);
      } else {
        requestAnimationFrame(scan);
      }
    }

    // === ВАЛИДАЦИЯ QR ===
    function isTelegramId(data) {
      // Проверяем, что это только цифры и длина похожа на Telegram ID (5–12 символов)
      return /^[0-9]{5,12}$/.test(data);
    }

    // === ОСТАНОВКА КАМЕРЫ + ОТОБРАЖЕНИЕ ===
    function stopCameraAndShowForm(qrText) {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }

      qrValue.textContent = qrText;
      cameraScreen.style.display = 'none';
      formScreen.classList.add('show');

      if (isTelegramId(qrText)) {
        warningText.textContent = '';
        amountBlock.style.display = 'block';
        amountInput.focus();
      } else {
        warningText.textContent = '⚠️ Это не Telegram ID. Начисление недоступно.';
        amountBlock.style.display = 'none';
      }
    }

    // === НАЧИСЛЕНИЕ ===
    function accrue() {
      const amount = parseFloat(amountInput.value);
      if (isNaN(amount) || amount <= 0) {
        alert('Введите корректную сумму!');
        return;
      }

      accrueBtn.disabled = true;
      accrueBtn.textContent = 'Начисляем...';

      fetch('/accrue', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ qr: lastQr, amount: amount })
      })
      .then(r => r.json())
      .then(data => {
        if (data.message) {
          alert(data.message);
          restart();
        } else {
          alert(data.error || 'Ошибка');
        }
      })
      .catch(() => alert('Нет связи с сервером'))
      .finally(() => {
        accrueBtn.disabled = false;
        accrueBtn.textContent = 'Начислить';
      });
    }

    // === ПОВТОРНОЕ СКАНИРОВАНИЕ ===
    function restart() {
      formScreen.classList.remove('show');
      cameraScreen.style.display = 'flex';
      lastQr = '';
      startCamera();
    }

    // === ENTER = НАЧИСЛИТЬ ===
    amountInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') accrue();
    });

    // === СТАРТ ===
    startCamera();
  </script>
</body>
</html>
